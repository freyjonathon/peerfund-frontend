{"ast":null,"code":"import _objectSpread from\"/Users/alabamalewis/Desktop/PeerFund/p2p_contract_frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";// src/features/loans/LoanThreadModal.jsx\nimport React,{useEffect,useRef,useState}from'react';import'./LoanThreadModal.css';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";function getToken(){return localStorage.getItem('token')||'';}export default function LoanThreadModal(_ref){let{loanId,onClose}=_ref;const[messages,setMessages]=useState([]);const[newMessage,setNewMessage]=useState('');const[loading,setLoading]=useState(true);const[sending,setSending]=useState(false);const listRef=useRef(null);const token=getToken();const fetchMessages=async()=>{try{setLoading(true);const res=await fetch(\"/api/loans/\".concat(loanId,\"/messages\"),{headers:token?{Authorization:\"Bearer \".concat(token)}:{}});if(!res.ok)throw new Error('Failed to load messages');const data=await res.json();setMessages(Array.isArray(data)?data:[]);}catch(err){console.error('Error fetching messages:',err);}finally{setLoading(false);// scroll to bottom after initial load\nsetTimeout(()=>{if(listRef.current)listRef.current.scrollTop=listRef.current.scrollHeight;},0);}};const sendMessage=async()=>{const text=newMessage.trim();if(!text)return;try{setSending(true);const res=await fetch(\"/api/loans/\".concat(loanId,\"/messages\"),{method:'POST',headers:_objectSpread({'Content-Type':'application/json'},token?{Authorization:\"Bearer \".concat(token)}:{}),body:JSON.stringify({content:text})});if(!res.ok)throw new Error('Failed to send message');setNewMessage('');await fetchMessages();// refresh\n// keep view pinned to bottom\nsetTimeout(()=>{if(listRef.current)listRef.current.scrollTop=listRef.current.scrollHeight;},0);}catch(err){console.error('Error sending message:',err);alert('Could not send message.');}finally{setSending(false);}};useEffect(()=>{if(!loanId)return;fetchMessages();// optional: poll every 15s (comment out if not desired)\n// const id = setInterval(fetchMessages, 15000);\n// return () => clearInterval(id);\n// eslint-disable-next-line react-hooks/exhaustive-deps\n},[loanId]);if(!loanId)return null;return/*#__PURE__*/_jsx(\"div\",{className:\"pf-modal-backdrop\",onClick:onClose,children:/*#__PURE__*/_jsxs(\"div\",{className:\"pf-modal\",onClick:e=>e.stopPropagation(),style:{maxWidth:720},children:[/*#__PURE__*/_jsxs(\"div\",{className:\"pf-modal-header\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"pf-modal-title\",children:\"\\uD83D\\uDCAC Loan Conversation\"}),/*#__PURE__*/_jsx(\"button\",{className:\"pf-modal-close\",onClick:onClose,\"aria-label\":\"Close\",children:\"\\u2715\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"pf-modal-body\",children:loading?/*#__PURE__*/_jsx(\"div\",{className:\"ltm-loading\",children:\"Loading messages\\u2026\"}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"ltm-list\",ref:listRef,children:messages.length===0?/*#__PURE__*/_jsx(\"div\",{className:\"ltm-empty\",children:\"No messages yet. Start the conversation!\"}):messages.map(msg=>{var _msg$user,_msg$sender;const name=((_msg$user=msg.user)===null||_msg$user===void 0?void 0:_msg$user.name)||((_msg$sender=msg.sender)===null||_msg$sender===void 0?void 0:_msg$sender.name)||'User';const when=msg.createdAt?new Date(msg.createdAt).toLocaleString():'';return/*#__PURE__*/_jsxs(\"div\",{className:\"ltm-item\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"ltm-item-head\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"ltm-name\",children:name}),/*#__PURE__*/_jsx(\"span\",{className:\"ltm-when\",children:when})]}),/*#__PURE__*/_jsx(\"div\",{className:\"ltm-text\",children:msg.content})]},msg.id);})}),/*#__PURE__*/_jsxs(\"div\",{className:\"ltm-composer\",children:[/*#__PURE__*/_jsx(\"textarea\",{rows:3,placeholder:\"Type your message\\u2026\",value:newMessage,onChange:e=>setNewMessage(e.target.value)}),/*#__PURE__*/_jsx(\"div\",{className:\"ltm-actions\",children:/*#__PURE__*/_jsx(\"button\",{className:\"action-btn primary\",onClick:sendMessage,disabled:sending||!newMessage.trim(),title:\"Send message\",children:sending?'Sendingâ€¦':'Send'})})]})]})})]})});}","map":{"version":3,"names":["React","useEffect","useRef","useState","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","getToken","localStorage","getItem","LoanThreadModal","_ref","loanId","onClose","messages","setMessages","newMessage","setNewMessage","loading","setLoading","sending","setSending","listRef","token","fetchMessages","res","fetch","concat","headers","Authorization","ok","Error","data","json","Array","isArray","err","console","error","setTimeout","current","scrollTop","scrollHeight","sendMessage","text","trim","method","_objectSpread","body","JSON","stringify","content","alert","className","onClick","children","e","stopPropagation","style","maxWidth","ref","length","map","msg","_msg$user","_msg$sender","name","user","sender","when","createdAt","Date","toLocaleString","id","rows","placeholder","value","onChange","target","disabled","title"],"sources":["/Users/alabamalewis/Desktop/PeerFund/p2p_contract_frontend/src/features/loans/LoanThreadModal.jsx"],"sourcesContent":["// src/features/loans/LoanThreadModal.jsx\nimport React, { useEffect, useRef, useState } from 'react';\nimport './LoanThreadModal.css';\n\nfunction getToken() {\n  return localStorage.getItem('token') || '';\n}\n\nexport default function LoanThreadModal({ loanId, onClose }) {\n  const [messages, setMessages] = useState([]);\n  const [newMessage, setNewMessage] = useState('');\n  const [loading, setLoading] = useState(true);\n  const [sending, setSending] = useState(false);\n  const listRef = useRef(null);\n\n  const token = getToken();\n\n  const fetchMessages = async () => {\n    try {\n      setLoading(true);\n      const res = await fetch(`/api/loans/${loanId}/messages`, {\n        headers: token ? { Authorization: `Bearer ${token}` } : {},\n      });\n      if (!res.ok) throw new Error('Failed to load messages');\n      const data = await res.json();\n      setMessages(Array.isArray(data) ? data : []);\n    } catch (err) {\n      console.error('Error fetching messages:', err);\n    } finally {\n      setLoading(false);\n      // scroll to bottom after initial load\n      setTimeout(() => {\n        if (listRef.current) listRef.current.scrollTop = listRef.current.scrollHeight;\n      }, 0);\n    }\n  };\n\n  const sendMessage = async () => {\n    const text = newMessage.trim();\n    if (!text) return;\n    try {\n      setSending(true);\n      const res = await fetch(`/api/loans/${loanId}/messages`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...(token ? { Authorization: `Bearer ${token}` } : {}),\n        },\n        body: JSON.stringify({ content: text }),\n      });\n      if (!res.ok) throw new Error('Failed to send message');\n      setNewMessage('');\n      await fetchMessages(); // refresh\n      // keep view pinned to bottom\n      setTimeout(() => {\n        if (listRef.current) listRef.current.scrollTop = listRef.current.scrollHeight;\n      }, 0);\n    } catch (err) {\n      console.error('Error sending message:', err);\n      alert('Could not send message.');\n    } finally {\n      setSending(false);\n    }\n  };\n\n  useEffect(() => {\n    if (!loanId) return;\n    fetchMessages();\n    // optional: poll every 15s (comment out if not desired)\n    // const id = setInterval(fetchMessages, 15000);\n    // return () => clearInterval(id);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [loanId]);\n\n  if (!loanId) return null;\n\n  return (\n    <div className=\"pf-modal-backdrop\" onClick={onClose}>\n      <div\n        className=\"pf-modal\"\n        onClick={(e) => e.stopPropagation()}\n        style={{ maxWidth: 720 }}\n      >\n        <div className=\"pf-modal-header\">\n          <div className=\"pf-modal-title\">ðŸ’¬ Loan Conversation</div>\n          <button className=\"pf-modal-close\" onClick={onClose} aria-label=\"Close\">\n            âœ•\n          </button>\n        </div>\n\n        <div className=\"pf-modal-body\">\n          {loading ? (\n            <div className=\"ltm-loading\">Loading messagesâ€¦</div>\n          ) : (\n            <>\n              <div className=\"ltm-list\" ref={listRef}>\n                {messages.length === 0 ? (\n                  <div className=\"ltm-empty\">No messages yet. Start the conversation!</div>\n                ) : (\n                  messages.map((msg) => {\n                    const name = msg.user?.name || msg.sender?.name || 'User';\n                    const when = msg.createdAt\n                      ? new Date(msg.createdAt).toLocaleString()\n                      : '';\n                    return (\n                      <div key={msg.id} className=\"ltm-item\">\n                        <div className=\"ltm-item-head\">\n                          <span className=\"ltm-name\">{name}</span>\n                          <span className=\"ltm-when\">{when}</span>\n                        </div>\n                        <div className=\"ltm-text\">{msg.content}</div>\n                      </div>\n                    );\n                  })\n                )}\n              </div>\n\n              <div className=\"ltm-composer\">\n                <textarea\n                  rows={3}\n                  placeholder=\"Type your messageâ€¦\"\n                  value={newMessage}\n                  onChange={(e) => setNewMessage(e.target.value)}\n                />\n                <div className=\"ltm-actions\">\n                  <button\n                    className=\"action-btn primary\"\n                    onClick={sendMessage}\n                    disabled={sending || !newMessage.trim()}\n                    title=\"Send message\"\n                  >\n                    {sending ? 'Sendingâ€¦' : 'Send'}\n                  </button>\n                </div>\n              </div>\n            </>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}