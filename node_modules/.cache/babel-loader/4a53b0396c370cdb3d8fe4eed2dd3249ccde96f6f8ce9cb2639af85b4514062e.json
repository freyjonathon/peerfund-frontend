{"ast":null,"code":"import React,{useEffect,useState}from'react';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const RepaymentForm=_ref=>{let{loanId,onPaymentSubmitted}=_ref;const[repaymentDetails,setRepaymentDetails]=useState(null);const[loading,setLoading]=useState(true);const[isStartingCheckout,setIsStartingCheckout]=useState(false);const token=localStorage.getItem('token');useEffect(()=>{const fetchRepaymentDetails=async()=>{try{const res=await fetch(\"/api/repayments/\".concat(loanId),{headers:{Authorization:\"Bearer \".concat(token)}});if(!res.ok)throw new Error('Failed to load repayments');const repayments=await res.json();const nextRepayment=repayments.find(r=>r.status==='PENDING');if(!nextRepayment){setRepaymentDetails(null);return;}setRepaymentDetails(nextRepayment);}catch(err){console.error('Error fetching repayment info:',err);alert('‚ö†Ô∏è Could not load repayment details.');}finally{setLoading(false);}};fetchRepaymentDetails();},[loanId,token]);if(loading)return/*#__PURE__*/_jsx(\"p\",{children:\"Loading repayment form...\"});if(!repaymentDetails)return/*#__PURE__*/_jsx(\"p\",{children:\"\\u2705 All repayments are complete!\"});const{id:repaymentId,basePayment=0,platformFee=0,bankFee=0,dueDate}=repaymentDetails;const totalDue=(Number(basePayment)+Number(platformFee||0)+Number(bankFee||0)).toFixed(2);const startCheckout=async()=>{try{setIsStartingCheckout(true);const res=await fetch('/api/payments/repayment-session',{method:'POST',headers:{'Content-Type':'application/json',Authorization:\"Bearer \".concat(token)},body:JSON.stringify({loanId,repaymentId// let backend lock the amount and add metadata\n})});if(!res.ok){const errJson=await res.json().catch(()=>({}));throw new Error(errJson.error||'Could not create checkout session');}const data=await res.json();if(data!==null&&data!==void 0&&data.url){window.location.href=data.url;// redirect to Stripe Checkout\n}else{throw new Error('No checkout URL returned');}}catch(err){console.error('Start checkout error:',err);alert('‚ö†Ô∏è There was a problem starting checkout. Please try again.');setIsStartingCheckout(false);}};return/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:'1rem'},children:[/*#__PURE__*/_jsx(\"h4\",{children:\"Make a Repayment\"}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Due Date:\"}),\" \",new Date(dueDate).toLocaleDateString()]}),/*#__PURE__*/_jsxs(\"ul\",{children:[/*#__PURE__*/_jsxs(\"li\",{children:[\"Principal + Interest: $\",Number(basePayment).toFixed(2)]}),/*#__PURE__*/_jsxs(\"li\",{children:[\"Banking Fee (1%): $\",Number(bankFee).toFixed(2)]}),/*#__PURE__*/_jsxs(\"li\",{children:[\"PeerFund Fee (1%): $\",Number(platformFee).toFixed(2),' ',Number(platformFee)===0&&/*#__PURE__*/_jsx(\"em\",{children:\"(Waived for SuperUsers \\uD83D\\uDC8E)\"})]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Total Due:\"}),\" $\",totalDue]})]}),/*#__PURE__*/_jsxs(\"label\",{children:[\"Amount Charged ($):\",/*#__PURE__*/_jsx(\"input\",{type:\"number\",value:totalDue,readOnly:true})]}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:startCheckout,disabled:isStartingCheckout,style:{marginTop:'0.5rem'},children:isStartingCheckout?'Starting checkout‚Ä¶':'Pay with Card'})]});};export default RepaymentForm;","map":{"version":3,"names":["React","useEffect","useState","jsx","_jsx","jsxs","_jsxs","RepaymentForm","_ref","loanId","onPaymentSubmitted","repaymentDetails","setRepaymentDetails","loading","setLoading","isStartingCheckout","setIsStartingCheckout","token","localStorage","getItem","fetchRepaymentDetails","res","fetch","concat","headers","Authorization","ok","Error","repayments","json","nextRepayment","find","r","status","err","console","error","alert","children","id","repaymentId","basePayment","platformFee","bankFee","dueDate","totalDue","Number","toFixed","startCheckout","method","body","JSON","stringify","errJson","catch","data","url","window","location","href","style","marginTop","Date","toLocaleDateString","type","value","readOnly","onClick","disabled"],"sources":["/Users/alabamalewis/Desktop/PeerFund/p2p_contract_frontend/src/features/loans/RepaymentForm.jsx"],"sourcesContent":["import React, { useEffect, useState } from 'react';\r\n\r\nconst RepaymentForm = ({ loanId, onPaymentSubmitted }) => {\r\n  const [repaymentDetails, setRepaymentDetails] = useState(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [isStartingCheckout, setIsStartingCheckout] = useState(false);\r\n\r\n  const token = localStorage.getItem('token');\r\n\r\n  useEffect(() => {\r\n    const fetchRepaymentDetails = async () => {\r\n      try {\r\n        const res = await fetch(`/api/repayments/${loanId}`, {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        });\r\n\r\n        if (!res.ok) throw new Error('Failed to load repayments');\r\n        const repayments = await res.json();\r\n\r\n        const nextRepayment = repayments.find((r) => r.status === 'PENDING');\r\n        if (!nextRepayment) {\r\n          setRepaymentDetails(null);\r\n          return;\r\n        }\r\n\r\n        setRepaymentDetails(nextRepayment);\r\n      } catch (err) {\r\n        console.error('Error fetching repayment info:', err);\r\n        alert('‚ö†Ô∏è Could not load repayment details.');\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchRepaymentDetails();\r\n  }, [loanId, token]);\r\n\r\n  if (loading) return <p>Loading repayment form...</p>;\r\n  if (!repaymentDetails) return <p>‚úÖ All repayments are complete!</p>;\r\n\r\n  const { id: repaymentId, basePayment = 0, platformFee = 0, bankFee = 0, dueDate } = repaymentDetails;\r\n  const totalDue = (Number(basePayment) + Number(platformFee || 0) + Number(bankFee || 0)).toFixed(2);\r\n\r\n  const startCheckout = async () => {\r\n    try {\r\n      setIsStartingCheckout(true);\r\n      const res = await fetch('/api/payments/repayment-session', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n        body: JSON.stringify({\r\n          loanId,\r\n          repaymentId, // let backend lock the amount and add metadata\r\n        }),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const errJson = await res.json().catch(() => ({}));\r\n        throw new Error(errJson.error || 'Could not create checkout session');\r\n      }\r\n\r\n      const data = await res.json();\r\n      if (data?.url) {\r\n        window.location.href = data.url; // redirect to Stripe Checkout\r\n      } else {\r\n        throw new Error('No checkout URL returned');\r\n      }\r\n    } catch (err) {\r\n      console.error('Start checkout error:', err);\r\n      alert('‚ö†Ô∏è There was a problem starting checkout. Please try again.');\r\n      setIsStartingCheckout(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div style={{ marginTop: '1rem' }}>\r\n      <h4>Make a Repayment</h4>\r\n      <p><strong>Due Date:</strong> {new Date(dueDate).toLocaleDateString()}</p>\r\n      <ul>\r\n        <li>Principal + Interest: ${Number(basePayment).toFixed(2)}</li>\r\n        <li>Banking Fee (1%): ${Number(bankFee).toFixed(2)}</li>\r\n        <li>\r\n          PeerFund Fee (1%): ${Number(platformFee).toFixed(2)}{' '}\r\n          {Number(platformFee) === 0 && <em>(Waived for SuperUsers üíé)</em>}\r\n        </li>\r\n        <li><strong>Total Due:</strong> ${totalDue}</li>\r\n      </ul>\r\n\r\n      {/* Amount is locked to what backend will charge via Stripe */}\r\n      <label>\r\n        Amount Charged ($):\r\n        <input type=\"number\" value={totalDue} readOnly />\r\n      </label>\r\n      <br />\r\n\r\n      <button type=\"button\" onClick={startCheckout} disabled={isStartingCheckout} style={{ marginTop: '0.5rem' }}>\r\n        {isStartingCheckout ? 'Starting checkout‚Ä¶' : 'Pay with Card'}\r\n      </button>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default RepaymentForm;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}